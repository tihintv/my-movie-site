<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin WebPhim</title>
  <style>
    body{font-family:sans-serif;background:#111;color:#fff;display:flex;justify-content:center;padding:20px}
    .box{width:800px;background:#1a1a1a;padding:20px;border-radius:10px}
    input,textarea{width:100%;margin:6px 0;padding:8px;border-radius:6px;border:none;background:#222;color:#fff}
    button{margin-top:6px;padding:8px 12px;border:none;border-radius:6px;color:#fff;cursor:pointer}
    button.add-btn{background:#3b82f6}
    button.delete-btn{background:#e11d48}
    button.edit-btn{background:#f59e0b}
    button.download-btn{background:#10b981}
    pre{background:#000;padding:10px;border-radius:6px;white-space:pre-wrap;max-height:300px;overflow:auto}
    .movie-list{margin-top:20px}
    .movie-item{background:#222;padding:10px;margin:6px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
    .movie-title{font-weight:bold}
    .btn-group{display:flex;gap:6px}
    .episode-item{display:flex;gap:6px;margin:5px 0}
    .episode-item input{flex:1}
    .episode-item button{margin-top:0}
    #posterPreview{max-width:150px;margin-top:6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="box">
    <h2 id="formTitle">‚ûï Th√™m phim m·ªõi</h2>
    <input id="title" placeholder="T√™n phim">
    <input id="year" placeholder="NƒÉm">
    <input id="genres" placeholder="Th·ªÉ lo·∫°i (c√°ch nhau d·∫•u ph·∫©y)">

    <!-- Poster upload -->
    <label>Poster:</label>
    <input type="file" id="posterFile" accept="image/*" onchange="handlePosterUpload(event)">
    <input id="poster" placeholder="Poster (v√≠ d·ª•: posters/abc.jpg)">
    <img id="posterPreview" src="" alt="Preview poster">

    <input id="videoUrl" placeholder="Video ch√≠nh (YouTube/MP4/Drive)">
    
    <h3>T·∫≠p phim</h3>
    <div id="episodesContainer"></div>
    <button onclick="addEpisodeField()">‚ûï Th√™m t·∫≠p</button>

    <textarea id="description" placeholder="M√¥ t·∫£"></textarea>
    <button class="add-btn" id="saveBtn" onclick="addMovie()">‚ûï L∆∞u phim</button>
    <button class="add-btn" style="display:none" id="updateBtn" onclick="updateMovie()">üíæ C·∫≠p nh·∫≠t phim</button>
    <button onclick="resetForm()">‚Ü©Ô∏è H·ªßy</button>

    <h2>Danh s√°ch phim</h2>
    <div class="movie-list" id="movieList"></div>

    <h3>D·ªØ li·ªáu JSON (copy ho·∫∑c t·∫£i xu·ªëng)</h3>
    <pre id="output"></pre>
    <button class="download-btn" onclick="downloadJSON()">üíæ T·∫£i movies.json</button>
  </div>

  <script>
    let movies = [];
    let editingId = null;

    async function loadMovies(){
      try{
        const res = await fetch("movies.json");
        movies = await res.json();
        renderMovies();
        updateOutput();
      }catch(e){
        console.error("Kh√¥ng load ƒë∆∞·ª£c movies.json", e);
      }
    }

    // Poster upload preview
    function handlePosterUpload(e){
      const file = e.target.files[0];
      if(file){
        document.getElementById("posterPreview").src=URL.createObjectURL(file);
        document.getElementById("poster").value="posters/"+file.name;
      }
    }

    // Episodes input
    function addEpisodeField(name="", url=""){
      const container = document.getElementById("episodesContainer");
      const div=document.createElement("div");
      div.className="episode-item";
      div.innerHTML=`
        <input type="text" placeholder="T√™n t·∫≠p" value="${name}">
        <input type="text" placeholder="URL" value="${url}">
        <button class="delete-btn" onclick="this.parentElement.remove()">‚ùå</button>
      `;
      container.appendChild(div);
    }

    function getEpisodesFromForm(){
      const rows=document.querySelectorAll("#episodesContainer .episode-item");
      return Array.from(rows).map(r=>{
        const inputs=r.querySelectorAll("input");
        return {name:inputs[0].value.trim(), url:inputs[1].value.trim()};
      }).filter(ep=>ep.name && ep.url);
    }

    function getFormData(){
      const title=document.getElementById("title").value.trim();
      const year=document.getElementById("year").value.trim();
      const genres=document.getElementById("genres").value.split(",").map(g=>g.trim()).filter(Boolean);
      let poster=document.getElementById("poster").value.trim();
      const videoUrl=document.getElementById("videoUrl").value.trim();
      const description=document.getElementById("description").value.trim();
      const episodes=getEpisodesFromForm();
      if(!poster.startsWith("http")) poster=poster.replace(/^\.?\//,"");
      return {title,year,genres,poster,videoUrl,episodes,description};
    }

    function addMovie(){
      const data=getFormData();
      movies.push({id:Date.now(),...data});
      renderMovies();
      updateOutput();
      resetForm();
    }

    function editMovie(id){
      const m=movies.find(x=>x.id===id);
      if(!m) return;
      editingId=id;

      document.getElementById("title").value=m.title;
      document.getElementById("year").value=m.year;
      document.getElementById("genres").value=m.genres.join(", ");
      document.getElementById("poster").value=m.poster;
      document.getElementById("videoUrl").value=m.videoUrl;
      document.getElementById("description").value=m.description;

      // episodes
      document.getElementById("episodesContainer").innerHTML="";
      (m.episodes||[]).forEach(ep=>addEpisodeField(ep.name,ep.url));

      document.getElementById("formTitle").textContent="‚úèÔ∏è S·ª≠a phim";
      document.getElementById("saveBtn").style.display="none";
      document.getElementById("updateBtn").style.display="inline-block";
    }

    function updateMovie(){
      const data=getFormData();
      movies=movies.map(m=>m.id===editingId?{...m,...data}:m);
      renderMovies();
      updateOutput();
      resetForm();
    }

    function deleteMovie(id){
      movies=movies.filter(m=>m.id!==id);
      renderMovies();
      updateOutput();
    }

    function renderMovies(){
      const list=document.getElementById("movieList");
      list.innerHTML=movies.map(m=>`
        <div class="movie-item">
          <span class="movie-title">${m.title} (${m.year})</span>
          <div class="btn-group">
            <button class="edit-btn" onclick="editMovie(${m.id})">‚úèÔ∏è S·ª≠a</button>
            <button class="delete-btn" onclick="deleteMovie(${m.id})">‚ùå Xo√°</button>
          </div>
        </div>
      `).join("");
    }

    function updateOutput(){
      document.getElementById("output").textContent=JSON.stringify(movies,null,2);
    }

    function downloadJSON(){
      const blob=new Blob([JSON.stringify(movies,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download="movies.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function resetForm(){
      editingId=null;
      document.querySelectorAll("input,textarea").forEach(el=>el.value="");
      document.getElementById("episodesContainer").innerHTML="";
      document.getElementById("posterPreview").src="";
      document.getElementById("formTitle").textContent="‚ûï Th√™m phim m·ªõi";
      document.getElementById("saveBtn").style.display="inline-block";
      document.getElementById("updateBtn").style.display="none";
    }

    loadMovies();
  </script>
</body>
</html>
