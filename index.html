<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebPhim</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#111;color:#eee}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#000}
    #q{padding:8px 12px;border-radius:6px;border:none;background:#222;color:#fff}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));padding:20px}
    .card{background:#1a1a1a;border-radius:10px;overflow:hidden;cursor:pointer;transition:.2s}
    .card:hover{transform:scale(1.03)}
    .poster{width:100%;aspect-ratio:2/3;object-fit:cover}
    .content{padding:10px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:#1a1a1a;padding:20px;border-radius:10px;max-width:800px;width:90%;position:relative}
    .close{position:absolute;top:10px;right:15px;cursor:pointer;font-size:20px}
    .watch-btn{display:inline-block;margin:8px 0;padding:8px 14px;background:#3b82f6;color:#fff;border-radius:6px;text-decoration:none}
    .episodes button{display:block;margin:4px 0;padding:6px;background:#333;color:#fff;border:none;border-radius:6px;cursor:pointer}
    .player iframe,.player video{width:100%;max-height:400px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <h1>🎬 WebPhim</h1>
    <input id="q" type="search" placeholder="Tìm phim...">
  </header>

  <div id="grid" class="grid"></div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="btnClose">×</span>
      <img id="mPoster" style="width:200px;float:left;margin-right:15px;border-radius:8px">
      <h2 id="mTitle"></h2>
      <p id="mYear"></p>
      <div id="mGenres"></div>
      <a id="btnWatch" class="watch-btn" target="_blank">▶ Xem phim</a>
      <div class="episodes" id="epsBox"></div>
      <p id="mDesc"></p>
      <div id="player" class="player"></div>
    </div>
  </div>

  <script>
    let movies=[];
    const BASE = "https://tihintv.github.io/webphim/";

    // Hàm chuẩn hoá đường dẫn poster
    function fixPoster(poster){
      if(!poster) return "";
      if(poster.startsWith("http")) return poster;
      return BASE + poster.replace(/^\.?\//,""); 
    }

    async function loadMovies(){
      try{
        const res=await fetch("movies.json");
        movies=await res.json();
        render(movies);
      }catch(e){console.error("Lỗi load movies.json",e);}
    }

    const grid=document.getElementById("grid");
    const q=document.getElementById("q");
    const modal=document.getElementById("modal");
    const btnClose=document.getElementById("btnClose");
    const mPoster=document.getElementById("mPoster");
    const mTitle=document.getElementById("mTitle");
    const mYear=document.getElementById("mYear");
    const mGenres=document.getElementById("mGenres");
    const mDesc=document.getElementById("mDesc");
    const btnWatch=document.getElementById("btnWatch");
    const epsBox=document.getElementById("epsBox");
    const player=document.getElementById("player");

    function render(list){
      grid.innerHTML=list.map(m=>{
        const poster=fixPoster(m.poster);
        return `
          <div class="card" data-id="${m.id}">
            <img class="poster" src="${poster}" alt="${m.title}" onerror="this.src='https://placehold.co/200x300?text=${m.title}'">
            <div class="content"><h3>${m.title}</h3><p>${m.year}</p></div>
          </div>`;
      }).join("");
      document.querySelectorAll(".card").forEach(c=>{
        c.onclick=()=>openModal(list.find(x=>x.id==c.dataset.id));
      });
    }

    function openModal(m){
      mPoster.src=fixPoster(m.poster);
      mTitle.textContent=m.title;
      mYear.textContent="Năm: "+(m.year||"");
      mGenres.innerHTML=(m.genres||[]).map(g=>`<span>${g}</span>`).join(", ");
      mDesc.textContent=m.description||"";
      btnWatch.style.display=m.videoUrl?"inline-block":"none";
      if(m.videoUrl) btnWatch.href=m.videoUrl;

      epsBox.innerHTML="";
      if(m.episodes && m.episodes.length){
        epsBox.innerHTML="<h3>Tập phim</h3>"+m.episodes.map(ep=>
          `<button onclick="document.getElementById('player').innerHTML=embed('${ep.url}')">${ep.name}</button>`
        ).join("");
      }
      player.innerHTML="";
      modal.classList.add("active");
    }

    function embed(url){
      if(url.includes("youtube")) return `<iframe src="${url.replace("watch?v=","embed/")}" allowfullscreen></iframe>`;
      if(url.includes("drive.google.com")) return `<iframe src="${url}" allow="autoplay"></iframe>`;
      if(url.endsWith(".mp4")) return `<video src="${url}" controls autoplay></video>`;
      return `<a href="${url}" target="_blank">Mở video</a>`;
    }

    btnClose.onclick=()=>modal.classList.remove("active");
    q.oninput=()=>{
      const k=q.value.toLowerCase();
      render(movies.filter(m=>
        m.title.toLowerCase().includes(k) ||
        (m.genres||[]).join(" ").toLowerCase().includes(k)
      ));
    };

    loadMovies();
  </script>
</body>
</html>
